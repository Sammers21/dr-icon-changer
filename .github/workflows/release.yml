name: Release

on:
    push:
        branches:
            - main

jobs:
    release:
        if: contains(github.event.head_commit.message, 'release')
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Generate CalVer version
              id: calver
              run: |
                  # Generate CalVer version: YYYY.MM.DD.RUN_NUMBER
                  VERSION=$(date +'%Y.%m.%d').${{ github.run_number }}
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "Generated version: $VERSION"

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: v${{ steps.calver.outputs.version }}
                  name: Release ${{ steps.calver.outputs.version }}
                  body: |
                      ## Release ${{ steps.calver.outputs.version }}

                      **Commit:** ${{ github.sha }}
                      **Message:** ${{ github.event.head_commit.message }}
                  draft: false
                  prerelease: false
                  generate_release_notes: true
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
