name: Release

on:
    push:
        branches:
            - main

jobs:
    release:
        if: contains(github.event.head_commit.message, 'release')
        runs-on: windows-latest
        permissions:
            contents: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Generate CalVer version
              id: calver
              shell: bash
              run: |
                  # Generate CalVer version: YYYY.MM.DD.RUN_NUMBER
                  VERSION=$(date +'%Y.%m.%d').${{ github.run_number }}
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "Generated version: $VERSION"

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install Rust
              uses: dtolnay/rust-toolchain@stable

            - name: Install dependencies
              run: npm ci

            - name: Update version in tauri.conf.json
              shell: bash
              run: |
                  VERSION="${{ steps.calver.outputs.version }}"
                  # Update version in tauri.conf.json
                  sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" src-tauri/tauri.conf.json
                  cat src-tauri/tauri.conf.json

            - name: Update version in Cargo.toml
              shell: bash
              run: |
                  VERSION="${{ steps.calver.outputs.version }}"
                  # Update version in Cargo.toml
                  sed -i "s/^version = \"[^\"]*\"/version = \"$VERSION\"/" src-tauri/Cargo.toml
                  cat src-tauri/Cargo.toml

            - name: Build Tauri app
              run: npm run tauri build

            - name: Rename MSI with version
              shell: bash
              run: |
                  VERSION="${{ steps.calver.outputs.version }}"
                  # Find and rename the MSI file
                  MSI_FILE=$(find src-tauri/target/release/bundle/msi -name "*.msi" | head -1)
                  if [ -n "$MSI_FILE" ]; then
                    NEW_NAME="DR-Icon-Changer-${VERSION}.msi"
                    cp "$MSI_FILE" "src-tauri/target/release/bundle/msi/$NEW_NAME"
                    echo "MSI_PATH=src-tauri/target/release/bundle/msi/$NEW_NAME" >> $GITHUB_ENV
                    echo "Renamed MSI to: $NEW_NAME"
                  else
                    echo "No MSI file found!"
                    exit 1
                  fi

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: v${{ steps.calver.outputs.version }}
                  name: Release ${{ steps.calver.outputs.version }}
                  body: |
                      ## DR Icon Changer v${{ steps.calver.outputs.version }}

                      ### Download
                      Download the MSI installer below and run it to install DR Icon Changer.

                      ### Changes
                      **Commit:** ${{ github.sha }}
                      **Message:** ${{ github.event.head_commit.message }}
                  draft: false
                  prerelease: false
                  generate_release_notes: true
                  files: |
                      ${{ env.MSI_PATH }}
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
